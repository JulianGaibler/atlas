"use strict";const e={displayName:"Mixed Theme",idName:"__mixed__",color:""};class t{constructor(e,t){this.messageMap=new Map,this.isScene=e;(e?window:figma.ui).onmessage=e=>{let a;a=this.isScene?e.data.pluginMessage:e;const s=(e,t)=>{const a={type:"response",id:e.id,payload:t};this.isScene?parent.postMessage({pluginMessage:a},"*"):figma.ui.postMessage(a)};if("response"===a.type){const e=this.messageMap.get(a.id);e&&(this.messageMap.delete(a.id),e(a.payload))}else t(a,s)}}sendMessage(e,t){return new Promise((a=>{const s={type:e,id:(new Date).getTime()+Math.random(),payload:t};this.isScene?parent.postMessage({pluginMessage:s},"*"):figma.ui.postMessage(s),this.messageMap.set(s.id,a)}))}}function a(e){return e.trim().toLowerCase().replace(/\s/g,"-")}function s(e){return e.split("/").map((e=>e.trim().toLowerCase().replace(/\s/g,"-"))).join("/")}function i(e){const t=e.indexOf("/");if(t<0)return null;const a=e.substr(0,t).trim(),s=e.substr(t+1);return a.length<1?null:{displayThemeName:a,displayStyleName:s}}function l(e){return JSON.stringify({mapName:e.mapName,lastUpdatedISO:e.lastUpdated.toISOString(),themes:e.themes,arrayMap:Array.from(e.map.entries())})}function n(e){return function(e,t){try{return e.constructor===t}catch(e){return!1}}(e,Object)?e.mapName&&e.lastUpdatedISO&&e.themes&&e.arrayMap?{success:!0,data:{mapName:String(e.mapName).trim(),lastUpdated:new Date(e.lastUpdatedISO),themes:e.themes,map:new Map(e.arrayMap)}}:{success:!1,type:"errMissingValue"}:{success:!1,type:"errNotAnObject"}}new class{constructor(){this.localMap={mapName:"",lastUpdated:null,themes:[],map:null},this.atlas=[],this.lastSelection=[],this.messenger=new t(!1,((e,t)=>{try{"getLocalThemes"===e.type?t(e,this.localMap.themes):"getSelection"===e.type?t(e,this.getSelection()):"categorizeSelection"===e.type?t(e,this.categorizeSelection()):"createTheme"===e.type?t(e,this.createTheme(e.payload.name,e.payload.color)):"duplicateTheme"===e.type?t(e,this.duplicateTheme(e.payload.from,e.payload.name,e.payload.color,e.payload.addWhitespace)):"editTheme"===e.type?t(e,this.editTheme(e.payload.from,e.payload.name,e.payload.color,e.payload.addWhitespace)):"getAllThemes"===e.type?t(e,[...this.localMap.themes,...this.atlas.map((e=>e.themes)).flat()]):"changeTheme"===e.type?this.changeTheme(e.payload.from,e.payload.to).then((a=>t(e,a))).catch((e=>{throw e})):"deleteTheme"===e.type?t(e,this.deleteTheme(e.payload.themeId,e.payload.deleteStyles)):"getLastMapUpdate"===e.type?t(e,this.localMap.lastUpdated?this.localMap.lastUpdated.toISOString():null):"refreshMap"===e.type?t(e,this.generateLocalMap()):"exportMap"===e.type?this.exportMap(e.payload.name).then((a=>t(e,a))).catch((e=>{throw e})):"importMap"===e.type?t(e,this.importMap(e.payload.json)):"getDocumentName"===e.type?t(e,figma.root.name):"selectMixedNodes"===e.type?t(e,this.selectMixedNodes()):"deleteFromAtlas"===e.type?t(e,this.deleteFromAtlas(e.payload.name)):"getAtlas"===e.type?t(e,this.atlas.map((e=>({mapName:e.mapName,lastUpdatedISO:e.lastUpdated.toISOString(),themes:e.themes})))):t(e,"error")}catch(a){throw t(e,{thrown:JSON.stringify(a)}),a}})),this.loadPluginStorage(),this.generateLocalMap(),figma.showUI(__html__,{width:290,height:485}),figma.on("selectionchange",(()=>this.messenger.sendMessage("selectionChange",this.getSelection())))}async changeTheme(e,t){const a=this.lastSelection.find((t=>t.theme.idName===e));if(!a)return;this.localMap.map,this.atlas.map((e=>e.map));const s=["fill","stroke","text","effect"];for(const e of s)for(const s of a[e]){let a=this.localMap.map.get(s.idStyleName),i=null;if(a&&a[t])this.typeCompare(e,a[t].type),this.typeCompare(e,a[t].type)&&(i=a[t].id);else{const l=this.atlas.map((e=>e.map));for(const n of l)if(a=n.get(s.idStyleName),a&&a[t]){const s=await figma.importStyleByKeyAsync(a[t].key);if(this.typeCompare(e,s.type)){i=s.id;break}}}if(i)switch(e){case"fill":s.node.fillStyleId=i;break;case"stroke":s.node.strokeStyleId=i;break;case"text":s.node.textStyleId=i;break;case"effect":s.node.effectStyleId=i}}}typeCompare(e,t){return"fill"===e&&"PAINT"===t||("stroke"===e&&"PAINT"===t||("text"===e&&"TEXT"===t||"effect"===e&&"EFFECT"===t))}findLocalThemeById(e){return this.localMap.themes.find((t=>t.idName===e))||null}findThemeById(e){return[...this.localMap.themes,...this.atlas.map((e=>e.themes)).flat()].find((t=>t.idName===e))||null}loadPluginStorage(){const e=figma.root.getPluginData("data");if(e.length<1)return;const t=JSON.parse(e);this.localMap=t.localMap,this.atlas=t.atlas.map((e=>n(JSON.parse(e)).data))}updatePluginStorage(){figma.root.setPluginData("data",JSON.stringify({version:1,localMap:this.localMap,atlas:this.atlas.map(l)}))}generateLocalMap(){const e=new Map;[...figma.getLocalPaintStyles(),...figma.getLocalTextStyles(),...figma.getLocalEffectStyles()].forEach((t=>{const l=i(t.name);if(null===l)return;const{displayThemeName:n,displayStyleName:o}=l,r=a(n);if(null===this.findLocalThemeById(r))return;const c={id:t.id,key:t.key,type:t.type},m=s(o),p=e.get(m)||{};p[r]=c,e.set(m,p)}));const t={mapName:figma.root.name,lastUpdated:new Date,themes:this.localMap.themes,map:e};return this.localMap=t,t}async exportLocalMap(){const e=new Map,t=[...figma.getLocalPaintStyles(),...figma.getLocalTextStyles(),...figma.getLocalEffectStyles()],l=[];for(const n of t){const t=await n.getPublishStatusAsync();if("CHANGED"===t)return{success:!1,type:"errUnpublishedChanges"};if("UNPUBLISHED"===t)break;const o=i(n.name);if(null===o)break;const{displayThemeName:r,displayStyleName:c}=o,m=a(r);l.includes(m)||l.push(m);if(null===this.findLocalThemeById(m))break;const p={id:n.id,key:n.key,type:n.type},h=s(c),d=e.get(h)||{};d[m]=p,e.set(h,d)}const n=this.localMap.themes.filter((e=>l.includes(e.idName)));return{success:!0,data:{mapName:figma.root.name,lastUpdated:new Date,themes:n,map:e}}}categorizeSelection(){const e=figma.currentPage.selection.flatMap((e=>void 0!==e.findAll?[e,...e.findAll()]:e)),t=[];return e.forEach((e=>{const a={fill:this.getThemeByFigmaStyleId(e.fillStyleId),stroke:this.getThemeByFigmaStyleId(e.strokeStyleId),text:this.getThemeByFigmaStyleId(e.textStyleId),effect:this.getThemeByFigmaStyleId(e.effectStyleId)};Object.keys(a).forEach((s=>{if(!a[s])return;const i={node:e,idStyleName:a[s].idStyleName},l=t.find((e=>e.theme===a[s].theme));if(l)l[s].push(i);else{const e={theme:a[s].theme,fill:[],stroke:[],text:[],effect:[]};e[s].push(i),t.push(e)}}))})),this.lastSelection=t,t}getThemeByFigmaStyleId(t){if(t===figma.mixed)return{theme:e,idStyleName:""};const l=figma.getStyleById(t);if(!l)return null;const n=i(l.name);if(!n)return null;const o=this.findThemeById(a(n.displayThemeName));return o?{theme:o,idStyleName:s(n.displayStyleName)}:void 0}selectMixedNodes(){const t=this.lastSelection.find((t=>t.theme.idName===e.idName));if(!t)return;const a=[],s=["fill","stroke","text","effect"];for(const e of s)for(const s of t[e])a.push(s.node);figma.currentPage.selection=a}createTheme(e,t){const a=this._createTheme(e,t);return a.success?(this.localMap.themes.push(a.newTheme),this.updatePluginStorage(),this.generateLocalMap(),{success:!0}):a}_createTheme(e,t){if(e.length<1)return{success:!1,type:"errTooShort"};if(e.includes("/"))return{success:!1,type:"errIncludesForwardSlash"};const s={displayName:e.trim(),idName:a(e),color:t};return null!==this.findLocalThemeById(s.idName)?{success:!1,type:"errDuplicateTheme"}:{success:!0,newTheme:s}}duplicateTheme(e,t,a,s){const l=this._createTheme(t,a);return l.success?(this.localMap.themes.push(l.newTheme),this.localMap.map.forEach((t=>{if(t[e]){const a=figma.getStyleById(t[e].id);if(null===a)return;let n;switch(a.type){case"PAINT":n=figma.createPaintStyle(),n.paints=a.paints;break;case"TEXT":n=figma.createTextStyle(),["fontSize","textDecoration","fontName","letterSpacing","lineHeight","paragraphIndent","paragraphSpacing","textCase"].forEach((e=>{n[e]=a[e]}));break;case"EFFECT":n=figma.createEffectStyle(),n.effects=a.effects}const{displayStyleName:o}=i(a.name);n.name=l.newTheme.displayName+(s?" ":"")+"/"+o,n.description=a.description}})),this.generateLocalMap(),this.updatePluginStorage(),{success:!0}):l}editTheme(e,t,a,s){let l=!1;const n=this.findLocalThemeById(e);if(n.displayName!==t.trim()){l=!0;const o=this._createTheme(t,a);if(!o.success)return o;n.displayName=o.newTheme.displayName,n.idName=o.newTheme.idName,this.localMap.map.forEach((a=>{if(a[e]){const l=figma.getStyleById(a[e].id),{displayStyleName:n}=i(l.name);l.name=t.trim()+(s?" ":"")+"/"+n}}))}return n.color!==a&&(l=!0,n.color=a),l&&(this.generateLocalMap(),this.updatePluginStorage()),{success:!0}}deleteTheme(e,t){const a=this.localMap.themes.findIndex((t=>t.idName===e));if(a<0)return{success:!1,type:"errThemeNotFound"};const s=this.localMap.themes.splice(a,1)[0];return t&&this.localMap.map.forEach((e=>{if(e[s.idName]){figma.getStyleById(e[s.idName].id).remove()}})),this.generateLocalMap(),this.updatePluginStorage(),{success:!0}}async exportMap(e){const t=await this.exportLocalMap();if(!t.success)return t;const a=t.data;return a.themes.length<1?{success:!1,type:"errNoThemeExported"}:(e&&(a.mapName=e.trim()),{success:!0,data:l(a)})}importMap(e){let t;try{t=JSON.parse(e)}catch(e){return{success:!1,type:"errJsonParse"}}const a=n(t);if(!a.success)return a;const s=a.data;for(const e of s.themes)if(this.findThemeById(e.idName))return{success:!1,type:"errThemeNameCollision",data:e.displayName};return this.atlas.push(s),this.updatePluginStorage(),{success:!0}}deleteFromAtlas(e){const t=this.atlas.findIndex((t=>t.mapName===e));return this.atlas.splice(t,1),this.updatePluginStorage(),{success:!0}}getSelection(){return figma.currentPage.selection.length}};
